<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Discord-style Voice Chat</title>
  <style>
    body { font-family: Arial; background: #222; color: #fff; text-align:center; padding:20px; }
    input, button { padding:5px; margin:5px; }
    audio { display:block; margin:10px auto; }
  </style>
</head>
<body>
  <h1>Multi-user Voice Chat (Discord style)</h1>
  <input id="room" placeholder="Room ID">
  <button id="join">Join Room</button>
  <div id="audios"></div>

  <script>
    let ws, pc;
    const audiosDiv = document.getElementById('audios');

    document.getElementById('join').onclick = async () => {
      const roomId = document.getElementById('room').value.trim();
      if (!roomId) return alert('Enter Room ID');

      ws = new WebSocket(`wss://${window.location.hostname}`);
      ws.onopen = () => ws.send(JSON.stringify({ type:'join', roomId }));

      // Capture microphone
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      
      pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      pc.ontrack = e => {
        const audio = document.createElement('audio');
        audio.autoplay = true;
        audio.srcObject = e.streams[0];
        audiosDiv.appendChild(audio);
      };

      pc.onicecandidate = e => {
        if (e.candidate && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type:'signal', payload:{ candidate:e.candidate } }));
        }
      };

      ws.onmessage = async e => {
        const msg = JSON.parse(e.data);
        if (msg.type !== 'signal') return;
        const { sdp, candidate } = msg.payload;

        if (sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(sdp));
          if (sdp.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type:'signal', payload:{ sdp:pc.localDescription } }));
          }
        }
        if (candidate) await pc.addIceCandidate(candidate);
      };

      // Create offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.onopen = () => ws.send(JSON.stringify({ type:'signal', payload:{ sdp:pc.localDescription } }));
    };
  </script>
</body>
</html>
